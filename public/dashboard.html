<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Principal - La Esquina</title>
    <style>
        body { background: #0c0c0c; color: white; font-family: sans-serif; margin: 0; padding: 20px; }
        
        /* HEADER Y BOTONES SUPERIORES */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        h1 { margin: 0; color: #f1c40f; }
        
        .stats-box { background: #181818; padding: 15px 30px; border-radius: 8px; border: 1px solid #333; text-align: center; }
        .stats-title { font-size: 14px; color: #888; text-transform: uppercase; }
        .stats-value { font-size: 28px; color: #2ecc71; font-weight: bold; }

        .actions-bar { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .btn-action { padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 14px; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        .btn-inv { background: #f39c12; color: black; }
        .btn-inv:hover { background: #d35400; }
        
        .btn-caja { background: #c0392b; color: white; }
        .btn-caja:hover { background: #e74c3c; }
        
        .btn-reportes { background: #3498db; color: white; }
        .btn-reportes:hover { background: #2980b9; }

        /* GRID DE MESAS */
        .grid-mesas { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .mesa-card { background: #181818; border-radius: 10px; padding: 20px; border: 1px solid #333; position: relative; transition: transform 0.2s; }
        .mesa-card:hover { transform: translateY(-5px); border-color: #555; }
        
        .mesa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mesa-titulo { font-size: 20px; font-weight: bold; color: #f1c40f; }
        .mesa-estado { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .libre { background: #27ae60; color: white; }
        .ocupada { background: #e74c3c; color: white; }

        .info-tiempo { font-size: 24px; font-family: monospace; text-align: center; margin: 15px 0; color: #ddd; }
        
        .mesa-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-mesa { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-abrir { background: #27ae60; color: white; }
        .btn-producto { background: #e67e22; color: white; }
        .btn-cerrar { background: #c0392b; color: white; grid-column: span 2; }

        /* MODAL DE PRODUCTOS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .modal h2 { color: #f1c40f; margin-top: 0; }
        .lista-productos { max-height: 300px; overflow-y: auto; text-align: left; margin: 15px 0; }
        .prod-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
        .prod-item:hover { background: #333; }
        .prod-precio { color: #2ecc71; font-weight: bold; }
        .btn-cancelar { background: #7f8c8d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üé± La Esquina - Control</h1>
        <div class="stats-box">
            <div class="stats-title">Caja Turno Actual</div>
            <div class="stats-value" id="total-caja">S/ 0.00</div>
        </div>
    </div>

    <div class="actions-bar">
        <a href="/inventario.html" class="btn-action btn-inv">üì¶ Inventario</a>
        <a href="/reportes.html" class="btn-action btn-reportes">üìÖ Ver Reportes Antiguos</a>
        <button onclick="cerrarCaja()" class="btn-action btn-caja">üîí CERRAR CAJA (Fin de Turno)</button>
    </div>

    <div id="grid-mesas" class="grid-mesas">
        <p style="color: #666; text-align: center; grid-column: 1/-1;">Cargando mesas...</p>
    </div>

    <div id="modal-productos" class="modal">
        <div class="modal-content">
            <h2>üç∫ Agregar Producto</h2>
            <p>Mesa: <span id="modal-mesa-nombre" style="color: #f39c12; font-weight: bold;"></span></p>
            <div class="lista-productos" id="lista-productos-div">
                </div>
            <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <script>
        let intervaloCronometros = null;

        // --- 1. CARGA INICIAL Y ACTUALIZACI√ìN ---
        async function cargarTodo() {
            await cargarMesas();
            await actualizarCaja();
        }

        async function actualizarCaja() {
            try {
                // LLAMA A LA NUEVA API DE CAJA MANUAL
                const res = await fetch('/api/caja/actual');
                const data = await res.json();
                document.getElementById('total-caja').innerText = 'S/ ' + parseFloat(data.total_dia).toFixed(2);
            } catch (e) { console.error("Error cargando caja:", e); }
        }

        // --- 2. GESTI√ìN DE MESAS ---
        async function cargarMesas() {
            try {
                const res = await fetch('/api/mesas');
                const mesas = await res.json();
                const contenedor = document.getElementById('grid-mesas');
                contenedor.innerHTML = '';

                mesas.forEach(mesa => {
                    const esOcupada = mesa.estado === 'OCUPADA';
                    const claseEstado = esOcupada ? 'ocupada' : 'libre';
                    const textoEstado = esOcupada ? 'OCUPADA' : 'LIBRE';
                    
                    // Si est√° ocupada, calculamos tiempo inicial para el cron√≥metro
                    let tiempoDisplay = '--:--:--';
                    let dataInicio = '';
                    
                    if (esOcupada && mesa.tipo === 'BILLAR' && mesa.hora_inicio) {
                        dataInicio = mesa.hora_inicio; // Guardamos la hora para el JS
                        tiempoDisplay = 'Calculando...';
                    }

                    const html = `
                        <div class="mesa-card">
                            <div class="mesa-header">
                                <span class="mesa-titulo">Mesa ${mesa.numero_mesa} (${mesa.tipo})</span>
                                <span class="mesa-estado ${claseEstado}">${textoEstado}</span>
                            </div>
                            
                            <div class="info-tiempo" id="timer-${mesa.id}" data-inicio="${dataInicio}">
                                ${tiempoDisplay}
                            </div>

                            <div class="mesa-actions">
                                ${!esOcupada ? 
                                    `<button class="btn-mesa btn-abrir" onclick="abrirMesa(${mesa.id})">üü¢ Abrir Mesa</button>` : 
                                    `<button class="btn-mesa btn-producto" onclick="abrirModalProductos(${mesa.id}, ${mesa.numero_mesa})">üç∫ Agregar Producto</button>
                                     <button class="btn-mesa btn-cerrar" onclick="cerrarMesa(${mesa.id})">üí∞ Cobrar y Cerrar</button>`
                                }
                            </div>
                        </div>
                    `;
                    contenedor.innerHTML += html;
                });
                
                iniciarCronometros(); // Reactivar relojes
            } catch (e) { console.error("Error cargando mesas:", e); }
        }

        // --- 3. ACCIONES DE MESAS ---
        async function abrirMesa(id) {
            if(!confirm("¬øAbrir esta mesa ahora?")) return;
            await fetch(`/api/mesas/abrir/${id}`, { method: 'POST' });
            cargarTodo();
        }

        async function cerrarMesa(id) {
            if(!confirm("¬øCerrar mesa y cobrar? Esta acci√≥n es final.")) return;
            
            const res = await fetch(`/api/mesas/cerrar/${id}`, { method: 'POST' });
            const data = await res.json();
            
            if (data.error) return alert("Error: " + data.error);

            // Mensaje de Cobro
            let mensaje = `üí∞ RESUMEN DE COBRO\n\n`;
            mensaje += `‚è∞ Tiempo (${data.minReal} min): S/ ${data.totalT}\n`;
            mensaje += `üç∫ Productos: S/ ${data.totalC}\n`;
            mensaje += `--------------------------\n`;
            mensaje += `üíµ TOTAL A PAGAR: S/ ${data.totalF}`;
            
            alert(mensaje);
            cargarTodo();
        }

        // --- 4. PRODUCTOS (MODAL) ---
        let mesaSeleccionadaId = null;

        async function abrirModalProductos(idMesa, numMesa) {
            mesaSeleccionadaId = idMesa;
            document.getElementById('modal-mesa-nombre').innerText = numMesa;
            document.getElementById('modal-productos').style.display = 'flex';
            
            // Cargar lista de productos
            const res = await fetch('/api/productos');
            const productos = await res.json();
            const divLista = document.getElementById('lista-productos-div');
            divLista.innerHTML = '';

            productos.forEach(p => {
                // Solo mostrar si hay stock
                if(p.stock > 0) {
                    divLista.innerHTML += `
                        <div class="prod-item" onclick="agregarPedido(${p.id}, '${p.nombre}', ${p.precio_venta})">
                            <span>${p.nombre} (Stock: ${p.stock})</span>
                            <span class="prod-precio">S/ ${parseFloat(p.precio_venta).toFixed(2)}</span>
                        </div>
                    `;
                }
            });
        }

        function cerrarModal() {
            document.getElementById('modal-productos').style.display = 'none';
        }

        async function agregarPedido(idProd, nombre, precio) {
            const cantidad = prompt(`¬øCu√°ntos "${nombre}" deseas agregar?`, "1");
            if (cantidad && parseInt(cantidad) > 0) {
                await fetch('/api/pedidos/agregar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        mesa_id: mesaSeleccionadaId, 
                        producto_id: idProd, 
                        cantidad: parseInt(cantidad) 
                    })
                });
                alert("‚úÖ Producto agregado");
                cerrarModal();
                actualizarCaja(); // Actualizar el total de caja en vivo
            }
        }

        // --- 5. L√ìGICA DE CIERRE DE CAJA (CORTE Z) ---
        async function cerrarCaja() {
            if(!confirm("‚ö†Ô∏è ¬øEst√°s seguro de CERRAR LA CAJA?\n\nEsto finalizar√° el turno actual y reiniciar√° el contador a cero.")) return;

            const res = await fetch('/api/caja/cerrar', { method: 'POST' });
            const data = await res.json();

            if(data.success) {
                alert(`‚úÖ TURNO CERRADO CON √âXITO.\n\nTotal recaudado: S/ ${parseFloat(data.total).toFixed(2)}\n\nEl sistema est√° listo para el siguiente turno.`);
                location.reload(); 
            } else {
                alert("Error al cerrar caja: " + (data.error || "Desconocido"));
            }
        }

        // --- 6. CRON√ìMETROS EN TIEMPO REAL ---
        function iniciarCronometros() {
            if(intervaloCronometros) clearInterval(intervaloCronometros);
            
            intervaloCronometros = setInterval(() => {
                const timers = document.querySelectorAll('.info-tiempo');
                timers.forEach(t => {
                    const inicio = t.getAttribute('data-inicio');
                    if(inicio && inicio !== '') {
                        const fechaInicio = new Date(inicio).getTime();
                        const ahora = new Date().getTime();
                        const diff = ahora - fechaInicio;
                        
                        // Formato HH:MM:SS
                        const horas = Math.floor(diff / (1000 * 60 * 60));
                        const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const segundos = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        t.innerText = 
                            (horas < 10 ? "0"+horas : horas) + ":" + 
                            (minutos < 10 ? "0"+minutos : minutos) + ":" + 
                            (segundos < 10 ? "0"+segundos : segundos);
                    }
                });
            }, 1000);
        }

        // Iniciar todo
        cargarTodo();
        // Refrescar datos cada 30 segundos (por si alguien m√°s abre mesas)
        setInterval(cargarMesas, 30000); 
        setInterval(actualizarCaja, 30000); 

    </script>
</body>
</html>