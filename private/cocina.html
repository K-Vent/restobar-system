<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üì∫ Monitor de Barra/Cocina - La Esquina</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0a0c">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="La Esquina KDS">
    <link rel="apple-touch-icon" href="/logo.png">
    <style>
        :root {
            --bg-main: #0a0a0c;
            --bg-card: #1c1c1e;
            --gold: #f1c40f;
            --success: #2ed573;
            --border: #2f3542;
            --text-muted: #a4b0be;
        }

        body { 
            background: var(--bg-main); 
            color: white; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            padding: 30px; 
            margin: 0; 
            min-height: 100vh; 
            box-sizing: border-box;
        }

        .header-cocina { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }

        .titulo { 
            color: var(--gold); 
            font-size: 32px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            font-weight: 900; 
            margin: 0; 
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
        }

        .reloj { 
            font-size: 28px; 
            font-weight: 800; 
            color: var(--text-muted); 
            font-family: 'Courier New', Courier, monospace; 
            background: #151515;
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .grid-pedidos { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 25px; 
        }
        
        .ticket { 
            background: var(--bg-card); 
            border-radius: 16px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            border: 1px solid var(--border); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            animation: popIn 0.4s ease-out;
        }

        @keyframes popIn { 
            0% { opacity: 0; transform: scale(0.9) translateY(20px); } 
            100% { opacity: 1; transform: scale(1) translateY(0); } 
        }

        .ticket:active { transform: scale(0.96); }
        
        /* Efecto Ne√≥n por Categor√≠as */
        .ticket::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; }
        .ticket.comida::before { background: #e67e22; box-shadow: 0 0 20px #e67e22; }
        .ticket.tragos::before { background: #9b59b6; box-shadow: 0 0 20px #9b59b6; }
        .ticket.cervezas::before { background: var(--gold); box-shadow: 0 0 20px var(--gold); }
        .ticket.otros::before { background: #3498db; box-shadow: 0 0 20px #3498db; }

        .ticket-header { 
            background: #151515; 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
        }
        
        .mesa { font-size: 26px; font-weight: 900; color: white; letter-spacing: -1px; }
        .hora { 
            font-size: 15px; 
            color: var(--text-muted); 
            background: #0a0a0c; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            border: 1px solid var(--border); 
        }

        .ticket-body { padding: 35px 20px; flex-grow: 1; text-align: center; }
        .cantidad { 
            font-size: 55px; 
            font-weight: 900; 
            color: var(--success); 
            display: block; 
            line-height: 1; 
            margin-bottom: 15px; 
            text-shadow: 0 0 25px rgba(46, 213, 115, 0.4); 
        }
        .producto { font-size: 24px; color: white; font-weight: 700; text-transform: uppercase; line-height: 1.2; }

        .btn-listo { 
            width: 100%; 
            padding: 22px; 
            background: rgba(46, 213, 115, 0.05); 
            color: var(--success); 
            border: none; 
            border-top: 1px solid rgba(46, 213, 115, 0.3); 
            font-weight: 900; 
            font-size: 22px; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
        }
        
        .btn-listo:hover, .btn-listo:active { 
            background: var(--success); 
            color: #000; 
            box-shadow: 0 0 30px rgba(46, 213, 115, 0.5); 
        }

        .vacio { 
            grid-column: 1 / -1; 
            text-align: center; 
            padding: 100px 20px; 
            color: var(--text-muted); 
            font-size: 28px; 
            border: 2px dashed var(--border); 
            border-radius: 20px; 
            font-weight: 700; 
            letter-spacing: 1px;
        }

        @media (max-width: 600px) {
            .header-cocina { flex-direction: column; gap: 15px; text-align: center; }
            .grid-pedidos { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="header-cocina">
        <div class="titulo">üë®‚Äçüç≥ Monitor de Barra y Cocina</div>
        <div class="reloj" id="reloj-vivo">00:00:00</div>
    </div>
    
    <div id="grid" class="grid-pedidos">
        <div class="vacio">Cargando sistema...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Reloj en vivo
        function actualizarReloj() {
            const ahora = new Date();
            document.getElementById('reloj-vivo').innerText = ahora.toLocaleTimeString('es-PE', { hour12: true });
        }
        setInterval(actualizarReloj, 1000);
        actualizarReloj();

        const socket = io();
        const campana = new Audio('https://actions.google.com/sounds/v1/alarms/dinner_bell_triangle.ogg');

        socket.on('campana_cocina', () => {
            cargarPendientes(); 
            campana.play().catch(e => console.log("Clic previo requerido para audio"));
            
            // Alerta visual de nuevo pedido
            document.body.style.backgroundColor = "#3a0000"; 
            setTimeout(() => document.body.style.backgroundColor = "#0a0a0c", 400);
        });

        socket.on('actualizar_cocina', () => { cargarPendientes(); });
    
        cargarPendientes();

        async function cargarPendientes() {
            try {
                const res = await fetch('/api/kds/pendientes');
                const pedidos = await res.json();
                const grid = document.getElementById('grid');
                
                if(pedidos.length === 0) {
                    grid.innerHTML = '<div class="vacio">‚ú® Todo entregado. Barra limpia.</div>';
                    return;
                }

                grid.innerHTML = ''; 

                pedidos.forEach(p => {
                    let tipo = 'otros';
                    if(p.categoria === 'Comida') tipo = 'comida';
                    else if(p.categoria === 'Tragos' || p.categoria === 'C√≥cteles') tipo = 'tragos';
                    else if(p.categoria === 'Cervezas') tipo = 'cervezas';

                    grid.innerHTML += `
                        <div class="ticket ${tipo}">
                            <div class="ticket-header">
                                <span class="mesa">Mesa ${p.numero_mesa}</span>
                                <span class="hora">‚è≥ ${p.hora}</span>
                            </div>
                            <div class="ticket-body">
                                <span class="cantidad">${p.cantidad}</span>
                                <span class="producto">${p.nombre}</span>
                            </div>
                            <button class="btn-listo" onclick="marcarListo(${p.id}, this)">‚úîÔ∏è LISTO</button>
                        </div>
                    `;
                });
            } catch(e) { console.error("Error conexi√≥n KDS", e); }
        }

        async function marcarListo(id, btnElement) {
            try {
                // Animaci√≥n de salida al entregar
                const ticket = btnElement.parentElement;
                ticket.style.transform = 'scale(0.8) translateY(50px)';
                ticket.style.opacity = '0';
                
                await fetch(`/api/kds/entregar/${id}`, { method: 'POST' });
                setTimeout(cargarPendientes, 250);
            } catch(e) { alert("Error al despachar"); }
        }
    </script>
</body>
</html>