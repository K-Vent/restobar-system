<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reportes y Estad√≠sticas</title>
    <link rel="icon" href="/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0c0c0c; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: #111; border-right: 1px solid #333; display: flex; flex-direction: column; position: fixed; height: 100%; top: 0; left: 0; }
        .sidebar-header { padding: 25px; text-align: center; border-bottom: 1px solid #222; }
        .logo-img { width: 180px; }
        .menu { padding: 20px 0; flex-grow: 1; }
        .menu-link { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: #aaa; text-decoration: none; transition: 0.2s; border-left: 3px solid transparent; }
        .menu-link:hover { background: #1a1a1a; color: white; }
        .menu-link.active { background: #1a1a1a; color: #f1c40f; border-left-color: #f1c40f; font-weight: bold; }
        .btn-logout { width: 90%; margin: 0 auto 20px; padding: 12px; background: #222; color: #e74c3c; border: 1px solid #333; border-radius: 6px; cursor: pointer; font-weight: bold; display: block; }

        .main-content { margin-left: 260px; padding: 40px; width: 100%; box-sizing: border-box; }
        .page-title { font-size: 28px; font-weight: bold; margin-bottom: 30px; color: white; }

        /* CONFIGURACI√ìN R√ÅPIDA */
        .config-bar { background: #181818; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 30px; display: flex; align-items: center; gap: 20px; }
        .config-label { font-weight: bold; color: #f1c40f; }
        .input-dark { background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 100px; text-align: center; }
        .btn-save { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* GRID DE GR√ÅFICOS */
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 40px; }
        .chart-card { background: #181818; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .chart-title { font-size: 16px; color: #888; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; }

        /* TABLA HISTORIAL */
        .tabla-container { background: #181818; border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #222; font-size: 14px; }
        th { background: #222; color: #f1c40f; }
        tr:hover { background: #1f1f1f; }
        .btn-del { background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        @media (max-width: 1000px) { .charts-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="/logo.png" class="logo-img"></div>
        <div class="menu">
            <a href="/dashboard.html" class="menu-link"><span class="menu-icon">üé±</span> Control de Mesas</a>
            <a href="/inventario.html" class="menu-link"><span class="menu-icon">üì¶</span> Inventario</a>
            <a href="#" class="menu-link active"><span class="menu-icon">üìÖ</span> Reportes</a>
            <a href="/cierre_caja.html" class="menu-link"><span class="menu-icon">üîí</span> Cerrar Caja</a>
        </div>
        <button onclick="location.href='/logout'" class="btn-logout">üö™ SALIR</button>
    </nav>

    <main class="main-content">
        <div class="page-title">üìà Estad√≠sticas y Configuraci√≥n</div>

        <div class="config-bar">
            <span class="config-label">‚öôÔ∏è Configuraci√≥n:</span>
            <span>Precio Hora Billar (S/):</span>
            <input type="number" id="conf-precio" class="input-dark" step="0.50">
            <button class="btn-save" onclick="guardarConfig()">Guardar Cambios</button>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">üìä Ventas √öltimos 7 D√≠as</div>
                <canvas id="chartVentas"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">üèÜ Top Productos</div>
                <canvas id="chartProductos"></canvas>
            </div>
        </div>

        <div class="chart-title" style="margin-bottom: 10px; color: white;">üìú Historial de Cierres de Caja</div>
        <div class="tabla-container">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Ventas</th>
                        <th>Gastos</th>
                        <th>Ganancia Real</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tabla-cierres"></tbody>
            </table>
        </div>
    </main>

    <script>
        // --- CONFIGURACI√ìN ---
        async function cargarConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                const precio = data.find(c => c.clave === 'precio_billar')?.valor || 10;
                document.getElementById('conf-precio').value = precio;
            } catch(e) { console.error(e); }
        }

        async function guardarConfig() {
            const precio = document.getElementById('conf-precio').value;
            if(confirm(`¬øCambiar precio del billar a S/ ${precio}?`)) {
                await fetch('/api/config', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ precio_billar: precio })
                });
                alert("‚úÖ Configuraci√≥n guardada.");
            }
        }

        // --- ESTAD√çSTICAS (GR√ÅFICOS) ---
        async function cargarEstadisticas() {
            const res = await fetch('/api/estadisticas/semana');
            const data = await res.json();

            // 1. Gr√°fico de Barras (Ventas)
            new Chart(document.getElementById('chartVentas'), {
                type: 'bar',
                data: {
                    labels: data.ventas.map(v => v.dia),
                    datasets: [{
                        label: 'Ventas (S/)',
                        data: data.ventas.map(v => v.total),
                        backgroundColor: '#2ecc71',
                        borderRadius: 5
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#333'} }, x: { grid: { display: false } } } }
            });

            // 2. Gr√°fico de Dona (Productos)
            new Chart(document.getElementById('chartProductos'), {
                type: 'doughnut',
                data: {
                    labels: data.top_productos.map(p => p.nombre),
                    datasets: [{
                        data: data.top_productos.map(p => p.cantidad),
                        backgroundColor: ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
            });
        }

        // --- HISTORIAL ---
        async function cargarHistorial() {
            const res = await fetch('/api/reportes/historial');
            const lista = await res.json();
            const tbody = document.getElementById('tabla-cierres');
            tbody.innerHTML = '';
            
            lista.forEach(cierre => {
                const fecha = new Date(cierre.fecha_cierre).toLocaleString();
                const ventas = parseFloat(cierre.total_ventas || 0);
                const gastos = parseFloat(cierre.total_gastos || 0);
                const real = ventas - gastos;

                tbody.innerHTML += `
                    <tr>
                        <td>${fecha}</td>
                        <td style="color:#2ecc71">S/ ${ventas.toFixed(2)}</td>
                        <td style="color:#e74c3c">S/ ${gastos.toFixed(2)}</td>
                        <td style="color:#f1c40f; font-weight:bold;">S/ ${real.toFixed(2)}</td>
                        <td><button class="btn-del" onclick="borrarReporte(${cierre.id})">üóëÔ∏è</button></td>
                    </tr>
                `;
            });
        }

        async function borrarReporte(id) {
            if(confirm("‚ö†Ô∏è ¬øBorrar este reporte? Se perder√° el historial de ese d√≠a.")) {
                await fetch(`/api/reportes/eliminar/${id}`, { method: 'DELETE' });
                cargarHistorial();
            }
        }

        // INICIALIZAR
        cargarConfig();
        cargarEstadisticas();
        cargarHistorial();
    </script>
</body>
</html>