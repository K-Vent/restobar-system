<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Mesas - La Esquina</title>
    <link rel="icon" href="/logo.png" type="image/png">
    <style>
        /* ESTILOS (IGUAL QUE ANTES) */
        body { background: #0c0c0c; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: 260px; background-color: #111; border-right: 1px solid #333; display: flex; flex-direction: column; position: fixed; height: 100%; top: 0; left: 0; z-index: 500; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid #222; text-align: center; }
        .logo-img { width: 100%; max-width: 220px; height: auto; display: block; margin: 0 auto 15px; object-fit: contain; }
        .btn-gasto { margin: 15px 20px; background: #c0392b; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: calc(100% - 40px); transition: 0.2s; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.3); }
        .btn-gasto:hover { background: #e74c3c; transform: translateY(-2px); }
        .menu { flex-grow: 1; padding: 10px 0; }
        .menu-link { display: flex; align-items: center; gap: 15px; padding: 15px 25px; color: #aaa; text-decoration: none; font-size: 16px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
        .menu-link:hover { background: #1a1a1a; color: white; border-left-color: #f1c40f; }
        .menu-link.active { background: #1a1a1a; color: #f1c40f; border-left-color: #f1c40f; font-weight: bold; }
        .menu-icon { font-size: 20px; width: 25px; text-align: center; }
        .logout-container { padding: 20px; border-top: 1px solid #222; }
        .btn-logout { width: 100%; padding: 12px; background: #222; color: #e74c3c; border: 1px solid #333; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; justify-content: center; gap: 10px; transition: 0.2s; }
        .main-content { margin-left: 260px; padding: 30px; width: 100%; transition: margin-left 0.3s ease; }
        .top-bar { display: flex; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: bold; color: white; margin: 0; }
        .money-panel { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card { background: #181818; padding: 20px; border-radius: 12px; border: 1px solid #333; flex: 1; min-width: 200px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .stat-title { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; }
        .stat-value { font-size: 28px; font-weight: bold; }
        .card-total .stat-value { color: #2ecc71; }
        .card-gastos .stat-value { color: #e74c3c; }
        .card-real { border: 1px solid #f39c12; background: rgba(243, 156, 18, 0.05); } .card-real .stat-value { color: #f39c12; }
        .grid-mesas { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .mesa-card { background: #181818; border-radius: 10px; padding: 20px; border: 1px solid #333; position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .mesa-card:hover { transform: translateY(-5px); border-color: #555; }
        .mesa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mesa-titulo { font-size: 18px; font-weight: bold; }
        .mesa-subtitulo { font-size: 12px; color: #777; margin-top: 2px; }
        .mesa-estado { font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .libre { background: rgba(39, 174, 96, 0.2); color: #2ecc71; border: 1px solid #27ae60; }
        .ocupada { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #c0392b; }
        .info-tiempo { font-size: 20px; font-family: 'Consolas', monospace; text-align: center; margin: 15px 0; color: #eee; background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        .dinero-vivo { color: #f1c40f; font-size: 14px; margin-top: 4px; font-weight: bold; }
        .mesa-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-mesa { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; font-size: 13px; transition: 0.2s; }
        .btn-abrir { background: #27ae60; color: white; }
        .btn-producto { background: #f39c12; color: black; }
        .btn-mover { background: #8e44ad; color: white; }
        .btn-cerrar { background: #c0392b; color: white; grid-column: span 2; }
        @keyframes parpadeo { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        /* MODALES */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #1e1e1e; padding: 0; border-radius: 12px; width: 90%; max-width: 450px; text-align: center; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.7); overflow: hidden; }
        .modal-title { font-size: 18px; color: #f1c40f; padding: 20px; border-bottom: 1px solid #333; font-weight: bold; background: #222; margin: 0; text-transform: uppercase; }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { display: block; color: #aaa; margin-bottom: 8px; font-size: 13px; font-weight: bold; }
        .modal-input { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 6px; font-size: 16px; box-sizing: border-box; outline: none; }
        .modal-btns { display: flex; gap: 15px; padding: 20px; background: #222; border-top: 1px solid #333; }
        .btn-modal { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; text-transform: uppercase; }
        .btn-cancel { background: #444; color: white; } 
        .btn-confirm { background: #27ae60; color: white; } 
        .btn-danger { background: #c0392b; color: white; }
        .btn-whatsapp { background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-whatsapp:hover { background: #128C7E; }
        .whatsapp-input-container { display: flex; gap: 10px; margin-top: 20px; border-top: 1px dashed #444; padding-top: 15px; }
        .input-telefono { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; text-align: center; font-size: 16px; outline: none; }
        .input-telefono:focus { border-color: #25D366; }
        .modal-box.wide { max-width: 800px; }
        .split-container { display: flex; height: 450px; text-align: left; }
        .split-sidebar { width: 180px; background: #151515; border-right: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; }
        .cat-btn { padding: 15px 20px; border: none; background: transparent; color: #888; text-align: left; cursor: pointer; border-left: 4px solid transparent; font-weight: 600; font-size: 14px; border-bottom: 1px solid #222; }
        .cat-btn:hover { background: #1a1a1a; color: white; } .cat-btn.active { background: #1f1f1f; color: #f1c40f; border-left-color: #f1c40f; }
        .split-content { flex: 1; padding: 0; overflow-y: auto; background: #1e1e1e; }
        .prod-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #333; cursor: pointer; }
        .prod-item:hover { background: #2a2a2a; padding-left: 25px; }
        .prod-name { font-size: 15px; font-weight: 500; } .prod-price { color: #2ecc71; font-weight: bold; font-size: 15px; }
        .detalle-lista { text-align: left; padding: 20px; max-height: 250px; overflow-y: auto; }
        .detalle-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #333; font-size: 14px; }
        .detalle-row.total-row { border-top: 2px solid #555; border-bottom: none; font-size: 20px; font-weight: bold; color: #2ecc71; margin-top: 15px; padding-top: 15px; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #27ae60; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; font-size: 16px; font-weight: bold; opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #modal-cantidad, #modal-msg, #modal-confirm { z-index: 1100 !important; }
        @media (max-width: 768px) { .sidebar { transform: translateX(-260px); } .main-content { margin-left: 0; } body.menu-visible .sidebar { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="toast">‚úÖ Acci√≥n realizada</div>
    
    <nav class="sidebar">
        <div class="sidebar-header"><img src="/logo.png" class="logo-img" alt="La Esquina"><div class="logo-sub">Panel de Control</div></div>
        <button class="btn-gasto" onclick="abrirModalGasto()">üí∏ Registrar Gasto</button>
        <div class="menu">
            <a href="#" class="menu-link active"><span class="menu-icon">üé±</span> Control de Mesas</a>
            <a href="/cocina.html" class="menu-link" target="_blank"><span class="menu-icon">üë®‚Äçüç≥</span> Pantalla Cocina</a>
            <a href="/inventario.html" class="menu-link"><span class="menu-icon">üì¶</span> Inventario</a>
            <a href="/reportes.html" class="menu-link"><span class="menu-icon">üìÖ</span> Historial</a>
            <a href="/cierre_caja.html" class="menu-link"><span class="menu-icon">üîí</span> Cerrar Caja</a>
        </div>
        <div class="logout-container"><button onclick="cerrarSesion()" class="btn-logout">üö™ SALIR</button></div>
    </nav>

    <main class="main-content">
        <div class="top-bar"><h2 class="page-title">Mesas y Pedidos</h2></div>
        
        <div class="money-panel">
            <div class="stat-card card-total"><div class="stat-title">üí∞ Ventas Totales</div><div class="stat-value" id="total-ventas">S/ 0.00</div></div>
            <div class="stat-card card-gastos"><div class="stat-title">üìâ Gastos (Salidas)</div><div class="stat-value" id="total-gastos">S/ 0.00</div></div>
            <div class="stat-card card-real"><div class="stat-title" style="color:#f39c12">üíµ EFECTIVO EN CAJA</div><div class="stat-value" id="total-real">S/ 0.00</div></div>
        </div>

        <div id="grid-mesas" class="grid-mesas"></div>
    </main>

    <div id="modal-abrir-mesa" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üé± Iniciar Mesa Billar</div>
            <div class="modal-body">
                <p style="color:#aaa; margin-bottom:20px;">Selecciona el modo de juego:</p>
                <button class="btn-modal" style="background:#2ecc71; color:white; width:100%; margin-bottom:15px; padding:15px;" onclick="ejecutarAbrirMesa(0)">‚è±Ô∏è TIEMPO LIBRE</button>
                <div style="border-top:1px solid #333; margin:15px 0; padding-top:15px;">
                    <p style="color:#f1c40f; font-weight:bold; margin-bottom:10px;">‚è≥ TIEMPO FIJO (L√≠mite)</p>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-modal" style="background:#333;border:1px solid #555;color:white;" onclick="ejecutarAbrirMesa(30)">30 min</button>
                        <button class="btn-modal" style="background:#333;border:1px solid #555;color:white;" onclick="ejecutarAbrirMesa(60)">1 Hora</button>
                        <button class="btn-modal" style="background:#333;border:1px solid #555;color:white;" onclick="ejecutarAbrirMesa(120)">2 Horas</button>
                    </div>
                </div>
            </div>
            <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-abrir-mesa')">Cancelar</button></div>
        </div>
    </div>

    <div id="modal-gasto" class="modal-overlay"><div class="modal-box"><div class="modal-title">üìâ Registrar Salida</div><div class="modal-body"><div class="form-group"><label class="form-label">Descripci√≥n</label><input type="text" id="gasto-desc" class="modal-input" placeholder="Ej. Hielo"></div><div class="form-group"><label class="form-label">Monto (S/)</label><input type="number" id="gasto-monto" class="modal-input" placeholder="0.00"></div></div><div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-gasto')">Cancelar</button><button class="btn-modal btn-danger" onclick="ejecutarGasto()">REGISTRAR</button></div></div></div>
    <div id="modal-productos" class="modal-overlay"><div class="modal-box wide"><div class="modal-title">üç∫ Seleccionar Producto</div><div class="split-container"><div id="cat-sidebar" class="split-sidebar"></div><div id="prod-content" class="split-content"></div></div><div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-productos')" style="width:100%">Cancelar</button></div></div></div>
    <div id="modal-cambio" class="modal-overlay"><div class="modal-box"><div class="modal-title">üîÑ Mover Mesa</div><div class="modal-body"><p style="color:#aaa; font-size:14px; margin-bottom:15px;">Destino:</p><select id="select-mesa-destino" class="modal-input"></select></div><div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-cambio')">Cancelar</button><button class="btn-modal" style="background:#8e44ad;color:white;" onclick="ejecutarCambioMesa()">CONFIRMAR</button></div></div></div>
    <div id="modal-confirm" class="modal-overlay"><div class="modal-box"><div class="modal-title" id="confirm-titulo"></div><div class="modal-body"><p id="confirm-texto" style="color:#ddd;"></p></div><div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-confirm')">Cancelar</button><button class="btn-modal btn-confirm" id="btn-confirm-ok">Aceptar</button></div></div></div>
    <div id="modal-cantidad" class="modal-overlay"><div class="modal-box"><div class="modal-title" id="cant-titulo"></div><div class="modal-body"><input type="number" id="input-cantidad" class="modal-input" value="1" style="text-align:center;font-size:30px;"></div><div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-cantidad')">Cancelar</button><button class="btn-modal btn-confirm" id="btn-cant-ok">AGREGAR</button></div></div></div>
    
    <div id="modal-cobro" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üßæ Resumen de Cuenta</div>
            <div id="cobro-contenido" class="detalle-lista"></div>
            <div class="whatsapp-input-container">
                <input type="tel" id="input-telefono-cliente" class="input-telefono" placeholder="üì± Celular (Opcional)">
                <button id="btn-whatsapp" class="btn-modal btn-whatsapp">üì© Enviar</button>
            </div>
            <div style="padding: 20px; background: #222; border-top: 1px solid #333;">
                <p style="color:#aaa; font-size:12px; margin-bottom:10px; font-weight:bold;">SELECCIONA M√âTODO DE PAGO:</p>
                <div style="display:flex; gap:10px; flex-direction: column;">
                    <button class="btn-modal" style="background:#27ae60; color:white; padding:15px;" onclick="ejecutarCobroFinal('EFECTIVO')">üíµ EFECTIVO</button>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-modal" style="background:#8e44ad; color:white;" onclick="ejecutarCobroFinal('YAPE')">üü£ YAPE / PLIN</button>
                        <button class="btn-modal" style="background:#2980b9; color:white;" onclick="ejecutarCobroFinal('TARJETA')">üí≥ TARJETA</button>
                    </div>
                </div>
            </div>
            <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="cerrarModal('modal-cobro')">Volver</button></div>
        </div>
    </div>

    <div id="modal-msg" class="modal-overlay"><div class="modal-box"><div class="modal-title" id="msg-titulo"></div><div class="modal-body"><p id="msg-texto" style="color:#ddd;"></p></div><div class="modal-btns"><button class="btn-modal btn-confirm" onclick="cerrarModal('modal-msg')">ENTENDIDO</button></div></div></div>

    <script>
        let intervaloCronometros = null;
        let mesaAccionId = null;
        let prodAccionId = null;
        let mesaOrigenCambio = null;
        let productosCache = [];
        let mensajeTicketGlobal = "";

        const audioAviso = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        const audioFinal = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');

        async function cargarTodo() {
            await solicitarPermisoNotificacion();
            await verificarRol();
            await cargarMesas();
            await actualizarCaja();
        }

        async function solicitarPermisoNotificacion() { if ("Notification" in window && Notification.permission !== "granted") { await Notification.requestPermission(); } }
        function enviarNotificacion(titulo, cuerpo) { if (Notification.permission === "granted") { new Notification(titulo, { body: cuerpo, icon: '/logo.png' }); } }

        async function verificarRol() {
            try {
                const res = await fetch('/api/usuario/actual');
                const user = await res.json();
                if (user.rol !== 'admin') {
                    document.querySelectorAll('.menu-link').forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && (href.includes('inventario') || href.includes('reportes'))) { link.style.display = 'none'; }
                    });
                }
            } catch (e) { console.error(e); }
        }

        function abrirModalGasto() { document.getElementById('gasto-desc').value = ''; document.getElementById('gasto-monto').value = ''; document.getElementById('modal-gasto').style.display = 'flex'; document.getElementById('gasto-desc').focus(); }
        async function ejecutarGasto() {
            const desc = document.getElementById('gasto-desc').value; const monto = document.getElementById('gasto-monto').value;
            if (!desc || !monto) { alert("Datos incompletos"); return; }
            const res = await fetch('/api/gastos/nuevo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ descripcion: desc, monto: monto }) });
            if (res.ok) { cerrarModal('modal-gasto'); mostrarToast("üí∏ Gasto registrado"); actualizarCaja(); } else { alert("Error"); }
        }
        async function actualizarCaja() { try { const res = await fetch('/api/caja/actual'); const data = await res.json(); document.getElementById('total-ventas').innerText = 'S/ ' + parseFloat(data.total_ventas).toFixed(2); document.getElementById('total-gastos').innerText = 'S/ ' + parseFloat(data.total_gastos).toFixed(2); document.getElementById('total-real').innerText = 'S/ ' + parseFloat(data.total_caja_real).toFixed(2); } catch (e) { console.error(e); } }

        // --- CARGAR MESAS (CON CRON√ìMETRO CORREGIDO) ---
        async function cargarMesas() {
            try {
                const res = await fetch('/api/mesas');
                const mesas = await res.json();
                const cont = document.getElementById('grid-mesas');
                cont.innerHTML = '';
                
                mesas.forEach(mesa => {
                    const esOcupada = mesa.estado === 'OCUPADA';
                    const esBillar = mesa.tipo === 'BILLAR';
                    
                    // [CORRECCI√ìN HORA] Usamos los segundos que vienen del servidor
                    let fechaInicioJS = "";
                    if (esOcupada && mesa.segundos > 0) {
                        // Restamos los segundos transcurridos al tiempo actual del navegador
                        fechaInicioJS = new Date(Date.now() - (mesa.segundos * 1000)).toISOString();
                    }

                    const dataAttrs = `data-id="${mesa.id}" data-inicio="${fechaInicioJS}" data-precio="${mesa.precio_hora}" data-limite="${mesa.tiempo_limite || 0}" data-mesa="${mesa.numero_mesa}"`;
                    
                    const htmlReloj = esBillar 
                        ? (esOcupada ? `<div class="info-tiempo" id="timer-${mesa.id}" ${dataAttrs}>...</div>` : `<div class="info-tiempo" style="color:#444;">--:--</div>`) 
                        : `<div style="height:10px;"></div>`;
                    
                    const clickIniciar = esBillar ? `mostrarConfirmacion('abrir', ${mesa.id})` : `abrirMesaDirecta(${mesa.id})`;

                    cont.innerHTML += `
                        <div class="mesa-card">
                            <div class="mesa-header"><div><div class="mesa-titulo">Mesa ${mesa.numero_mesa}</div><div class="mesa-subtitulo">${mesa.tipo}</div></div><span class="mesa-estado ${esOcupada ? 'ocupada' : 'libre'}">${esOcupada ? 'OCUPADA' : 'LIBRE'}</span></div>
                            ${htmlReloj}
                            <div class="mesa-actions">
                                ${!esOcupada ? `<button class="btn-mesa btn-abrir" onclick="${clickIniciar}">üü¢ INICIAR</button>` : `<button class="btn-mesa btn-producto" onclick="abrirModalProductos(${mesa.id})">üç∫ PEDIDO</button><button class="btn-mesa btn-mover" onclick="abrirModalCambio(${mesa.id})">üîÑ MOVER</button><button class="btn-mesa btn-cerrar" onclick="prepararCobro(${mesa.id}, '${mesa.numero_mesa}')">üí∞ COBRAR</button>`}
                            </div>
                        </div>`;
                });
                iniciarCronometros();
            } catch (e) { console.error(e); }
        }

        async function abrirMesaDirecta(id) { mesaAccionId = id; await ejecutarAbrirMesa(0); }
        function mostrarConfirmacion(tipo, id) { mesaAccionId = id; if (tipo === 'abrir') document.getElementById('modal-abrir-mesa').style.display = 'flex'; }
        async function ejecutarAbrirMesa(minutos) {
            cerrarModal('modal-abrir-mesa');
            await fetch(`/api/mesas/abrir/${mesaAccionId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ minutos: minutos }) });
            mostrarToast(minutos > 0 ? `‚è≥ Mesa abierta por ${minutos} min` : "‚úÖ Mesa abierta");
            cargarTodo();
        }

        function iniciarCronometros() {
            if (intervaloCronometros) clearInterval(intervaloCronometros);
            intervaloCronometros = setInterval(() => {
                document.querySelectorAll('.info-tiempo').forEach(t => {
                    const inicio = t.getAttribute('data-inicio');
                    const precio = parseFloat(t.getAttribute('data-precio') || 10);
                    const limite = parseInt(t.getAttribute('data-limite') || 0);
                    const numMesa = t.getAttribute('data-mesa');

                    if (inicio && inicio !== "undefined" && inicio !== "") {
                        const diff = new Date() - new Date(inicio); // Esto ahora es preciso porque "inicio" se ajust√≥ al navegador
                        
                        if (limite > 0) {
                            const restMs = (limite * 60000) - diff;
                            const restMin = Math.floor(restMs / 60000);
                            
                            if (restMin === 5 && t.dataset.aviso5 !== "true") { enviarNotificacion(`‚ö†Ô∏è Mesa ${numMesa}`, "Quedan 5 min"); audioAviso.play().catch(()=>{}); t.dataset.aviso5 = "true"; }
                            if (restMs <= 0 && t.dataset.avisoFin !== "true") { enviarNotificacion(`üö® Mesa ${numMesa}`, "¬°TIEMPO TERMINADO!"); audioFinal.play().catch(()=>{}); t.dataset.avisoFin = "true"; }

                            if (restMs <= 0) { t.innerHTML = `<div style="color:#e74c3c;font-weight:bold;animation:parpadeo 1s infinite;">‚õî ¬°TIEMPO! ‚õî</div><div class="dinero-vivo">Extra: ${Math.abs(restMin)} min</div>`; t.parentElement.style.border = "2px solid #e74c3c"; } 
                            else { const h = Math.floor(restMs / 3600000); const m = Math.floor((restMs % 3600000) / 60000); const s = Math.floor((restMs % 60000) / 1000); t.innerHTML = `<div style="color:#f1c40f;font-size:12px;">‚è≥ Quedan:</div><div style="font-size:24px;font-weight:bold;">${h}:${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}</div>`; }
                        } else {
                            const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const costo = (diff / 60000 / 60) * precio;
                            t.innerHTML = `${h}:${m < 10 ? '0' + m : m} <div class="dinero-vivo">S/ ${costo.toFixed(2)}</div>`;
                        }
                    }
                });
            }, 1000);
        }

        async function abrirModalProductos(id) {
            mesaAccionId = id; const res = await fetch('/api/productos'); productosCache = await res.json();
            const cats = ['Todos']; productosCache.forEach(p => { const c = p.categoria || 'General'; if (!cats.includes(c)) cats.push(c); });
            const sb = document.getElementById('cat-sidebar'); sb.innerHTML = '';
            cats.forEach(c => { let i = 'üì¶'; if (c == 'Cervezas') i = 'üç∫'; if (c == 'Tragos' || c == 'C√≥cteles') i = 'üçπ'; if (c == 'Comida') i = 'üçî'; sb.innerHTML += `<button class="cat-btn" onclick="filtrarProductos('${c}', this)">${i} ${c}</button>`; });
            if (sb.children.length > 0) filtrarProductos('Todos', sb.children[0]);
            document.getElementById('modal-productos').style.display = 'flex';
        }

        function filtrarProductos(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); if (btn) btn.classList.add('active');
            const cont = document.getElementById('prod-content'); cont.innerHTML = '';
            const list = productosCache.filter(p => cat === 'Todos' ? true : (p.categoria || 'General') === cat);
            list.forEach(p => { 
                if (p.stock > 0) { 
                    // [CORRECCI√ìN MIKE'S]
                    const nombreSeguro = p.nombre.replace(/'/g, "\\'"); 
                    cont.innerHTML += `<div class="prod-item" onclick="mostrarInputCantidad(${p.id}, '${nombreSeguro}')"><div class="prod-name">${p.nombre}</div><span class="prod-price">S/ ${parseFloat(p.precio_venta).toFixed(2)}</span></div>`; 
                } 
            });
        }

        function mostrarInputCantidad(pid, nom) { prodAccionId = pid; document.getElementById('cant-titulo').innerText = nom; document.getElementById('input-cantidad').value = 1; document.getElementById('modal-cantidad').style.display = 'flex'; document.getElementById('btn-cant-ok').onclick = ejecutarAgregarPedido; setTimeout(() => document.getElementById('input-cantidad').focus(), 100); }
        async function ejecutarAgregarPedido() {
            const cant = document.getElementById('input-cantidad').value;
            if (cant > 0) {
                await fetch('/api/pedidos/agregar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mesa_id: mesaAccionId, producto_id: prodAccionId, cantidad: cant }) });
                cerrarModal('modal-cantidad'); cerrarModal('modal-productos'); mostrarToast("‚ú® Producto Agregado"); actualizarCaja();
            }
        }

        async function prepararCobro(id, numMesa) {
            mesaAccionId = id; document.getElementById('cobro-contenido').innerHTML = 'Calculando...'; document.getElementById('modal-cobro').style.display = 'flex'; document.getElementById('input-telefono-cliente').value = ''; 
            try {
                const res = await fetch(`/api/mesas/detalle/${id}`); const data = await res.json();
                let html = ''; let texto = `üßæ *LA ESQUINA DEL BILLAR*%0AüìÖ Fecha: ${new Date().toLocaleDateString()}%0Aüé± *Mesa ${numMesa}*%0A------------------%0A`;
                if (data.tipo === 'BILLAR') { const costoT = parseFloat(data.totalTiempo).toFixed(2); html += `<div class="detalle-row"><span style="color:#f1c40f">üé± Tiempo (${data.minutos} min)</span><span>S/ ${costoT}</span></div>`; texto += `üé± Tiempo (${data.minutos} min): S/ ${costoT}%0A`; }
                if (data.listaProductos) { html += '<div style="border-top:1px dashed #444; margin:10px 0"></div>'; data.listaProductos.forEach(p => { html += `<div class="detalle-row" style="align-items:center"><div style="display:flex; gap:10px"><button onclick="eliminarPedido(${p.id}, '${p.nombre}')" style="background:#c0392b; border:none; color:white; border-radius:4px; cursor:pointer">üóëÔ∏è</button><span>${p.cantidad}x ${p.nombre}</span></div><span>S/ ${parseFloat(p.subtotal).toFixed(2)}</span></div>`; texto += `üç∫ ${p.cantidad}x ${p.nombre}: S/ ${parseFloat(p.subtotal).toFixed(2)}%0A`; }); }
                const totalF = parseFloat(data.totalFinal).toFixed(2); html += `<div class="detalle-row total-row"><span>TOTAL</span><span>S/ ${totalF}</span></div>`; texto += `------------------%0Aüí∞ *TOTAL: S/ ${totalF}*%0A¬°Gracias por tu visita!`;
                mensajeTicketGlobal = texto; document.getElementById('cobro-contenido').innerHTML = html;
            } catch (e) { console.error(e); }
        }

        document.getElementById('btn-whatsapp').onclick = () => {
            const tel = document.getElementById('input-telefono-cliente').value.trim();
            const esCel = /Android|iPhone|iPad/i.test(navigator.userAgent);
            const base = esCel ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";
            let url = (tel.length >= 9) ? `${base}?phone=51${tel}&text=${mensajeTicketGlobal}` : `${base}?text=${mensajeTicketGlobal}`;
            window.open(url, '_blank');
        };

        async function ejecutarCobroFinal(metodo) {
            if(!confirm(`¬øCobrar con ${metodo}?`)) return;
            await fetch(`/api/mesas/cerrar/${mesaAccionId}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ metodo: metodo }) });
            cerrarModal('modal-cobro'); mostrarToast("‚úÖ Cobrado"); cargarTodo();
        }

        async function eliminarPedido(pid, nom) { if (confirm(`¬øEliminar "${nom}"?`)) { await fetch(`/api/pedidos/eliminar/${pid}`, { method: 'DELETE' }); const num = document.querySelector(`#timer-${mesaAccionId}`)?.getAttribute('data-mesa') || "?"; prepararCobro(mesaAccionId, num); actualizarCaja(); } }
        async function abrirModalCambio(id) { mesaOrigenCambio = id; const r = await fetch('/api/mesas'); const m = await r.json(); const l = m.filter(x => x.estado === 'LIBRE'); const s = document.getElementById('select-mesa-destino'); s.innerHTML = ''; if (l.length == 0) { alert("No hay mesas libres"); return; } l.forEach(x => s.innerHTML += `<option value="${x.id}">Mesa ${x.numero_mesa}</option>`); document.getElementById('modal-cambio').style.display = 'flex'; }
        async function ejecutarCambioMesa() { await fetch('/api/mesas/cambiar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ idOrigen: mesaOrigenCambio, idDestino: document.getElementById('select-mesa-destino').value }) }); cerrarModal('modal-cambio'); cargarTodo(); }
        function cerrarSesion() { if (confirm("¬øSeguro que quieres salir?")) window.location.href = '/logout'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
        function mostrarToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.className = "show"; setTimeout(() => t.className = t.className.replace("show", ""), 2500); }

        cargarTodo(); setInterval(cargarMesas, 15000);
    </script>
</body>
</html>