<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cerrar Caja - La Esquina</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0a0c">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/css/dashboard.css?v=2">
    <link rel="icon" href="/logo.png" type="image/png">
    <style>
        /* Estilos especÃ­ficos premium para la tabla de caja */
        .tabla-container { background: var(--bg-card); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .tabla-header { background: #151515; padding: 20px 25px; font-weight: 800; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); color: var(--gold); font-size: 18px; letter-spacing: 0.5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 25px; text-align: left; border-bottom: 1px solid #1f222b; font-size: 15px; }
        th { color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        tr:hover { background: var(--bg-card-hover); }
        
        .tag-pago { font-size: 11px; padding: 6px 10px; border-radius: 6px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .tag-efectivo { background: var(--success-dim); color: var(--success); border: 1px solid rgba(46, 213, 115, 0.3); }
        .tag-yape { background: rgba(155, 89, 182, 0.15); color: #c56cf0; border: 1px solid rgba(155, 89, 182, 0.3); }
        .tag-tarjeta { background: rgba(52, 152, 219, 0.15); color: #3498db; border: 1px solid rgba(52, 152, 219, 0.3); }

        .btn-borrar { background: var(--danger-dim); color: var(--danger); border: 1px solid rgba(255, 71, 87, 0.3); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-borrar:hover { background: var(--danger); color: white; transform: scale(1.1); }
        
        .page-title { font-size: 32px; font-weight: 800; margin-bottom: 30px; color: white; letter-spacing: -1px; }
        .btn-logout { margin: 20px; padding: 14px; background: var(--danger-dim); color: var(--danger); border: 1px solid rgba(255, 71, 87, 0.3); border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-logout:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="/logo.png" class="logo-img"></div>
        <div class="menu">
            <a href="/dashboard.html" class="menu-link">ğŸ± Control de Mesas</a>
            <a href="/inventario.html" class="menu-link">ğŸ“¦ Inventario</a>
            <a href="/reportes.html" class="menu-link">ğŸ“… Historial</a>
            <a href="#" class="menu-link active">ğŸ”’ Cerrar Caja</a>
            <a href="/auditoria.html" class="menu-link" style="color: var(--danger);">ğŸ•µï¸â€â™‚ï¸ AuditorÃ­a</a>
            <a href="/empleados.html" class="menu-link">ğŸ‘¥ Empleados</a>
        </div>
        <a href="/logout" class="menu-link link-logout-pc">ğŸšª Salir</a>
    </nav>

    <main class="main-content">
        <div class="page-title">ğŸ”’ Cierre de Turno</div>

        <div class="money-panel">
            <div class="stat-card">
                <div class="stat-title">ğŸ’° Ventas Totales</div>
                <div class="stat-value" id="lbl-total-ventas">S/ 0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ“± Yape / Tarjeta</div>
                <div class="stat-value" style="color: #c56cf0;" id="lbl-digital">S/ 0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ“‰ Gastos (Salidas)</div>
                <div class="stat-value" id="lbl-gastos" style="color: var(--danger);">S/ 0.00</div>
            </div>
            <div class="stat-card card-real">
                <div class="stat-title">ğŸ’µ DINERO EN CAJÃ“N</div>
                <div class="stat-value" id="lbl-en-cajon">S/ 0.00</div>
            </div>
        </div>

        <div class="tabla-container">
            <div class="tabla-header">ğŸ“œ Detalle de Movimientos</div>
            <table id="tabla-ventas">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Concepto</th>
                        <th>MÃ©todo</th>
                        <th style="text-align: right;">Monto</th>
                        <th style="text-align: center; width: 60px;">AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody id="tbody-ventas">
                    <tr><td colspan="5" style="text-align:center; color:#555;">Cargando...</td></tr>
                </tbody>
            </table>
        </div>

        <button class="btn-mesa btn-abrir" style="font-size: 18px; padding: 20px;" onclick="pedirCierre()">ğŸ”’ CONFIRMAR Y CERRAR CAJA</button>
    </main>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-titulo">âš ï¸ ConfirmaciÃ³n</div>
            <div class="modal-body" id="modal-texto" style="text-align: center; font-size: 16px; color: #ccc;">Â¿EstÃ¡s seguro?</div>
            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-modal" id="btn-modal-ok" style="background: var(--danger); color: white;">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <script src="/js/alertas.js"></script>

    <script>
        // Tu lÃ³gica Javascript original se mantiene intacta
        let accionPendiente = null; 

        async function cargarDatos() {
            try {
                const res = await fetch('/api/caja/actual');
                const data = await res.json();

                document.getElementById('lbl-total-ventas').innerText = 'S/ ' + data.total_ventas.toFixed(2);
                document.getElementById('lbl-gastos').innerText = 'S/ ' + data.total_gastos.toFixed(2);
                const totalDigital = data.desglose.digital + (data.desglose.tarjeta || 0);
                document.getElementById('lbl-digital').innerText = 'S/ ' + totalDigital.toFixed(2);
                document.getElementById('lbl-en-cajon').innerText = 'S/ ' + data.dinero_en_cajon.toFixed(2);

                const tbody = document.getElementById('tbody-ventas');
                tbody.innerHTML = '';

                if (data.lista && data.lista.length > 0) {
                    data.lista.forEach(venta => {
                        let concepto = venta.tipo_mesa === 'BILLAR' ? 'ğŸ± Billar' : 'ğŸ›’ Consumo';
                        let metodo = venta.metodo_pago || 'EFECTIVO';
                        let tagClass = 'tag-efectivo';
                        if(metodo === 'YAPE' || metodo === 'PLIN') tagClass = 'tag-yape';
                        if(metodo === 'TARJETA') tagClass = 'tag-tarjeta';

                        tbody.innerHTML += `
                            <tr>
                                <td style="color:var(--text-muted);">${venta.hora}</td>
                                <td style="font-weight: 600;">${concepto} <span style="color:#555; font-size:11px; margin-left: 8px;">#${venta.id}</span></td>
                                <td><span class="tag-pago ${tagClass}">${metodo}</span></td>
                                <td style="text-align: right; color:white; font-weight:bold;">S/ ${parseFloat(venta.total_final).toFixed(2)}</td>
                                <td style="text-align: center;">
                                    <button class="btn-borrar" onclick="pedirBorrar(${venta.id})" title="Eliminar Venta">ğŸ—‘ï¸</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#555;">No hay ventas registradas.</td></tr>';
                }
            } catch (e) { console.error(e); }
        }

        function cerrarModal() { document.getElementById('modal-confirm').style.display = 'none'; }

        function pedirBorrar(id) {
            document.getElementById('modal-titulo').innerText = "ğŸ—‘ï¸ Eliminar Venta";
            document.getElementById('modal-texto').innerText = "Â¿EstÃ¡s seguro de eliminar este cobro del reporte? Esto afectarÃ¡ el total en caja.";
            const btnOk = document.getElementById('btn-modal-ok');
            btnOk.style.background = "var(--danger)";
            btnOk.innerText = "ELIMINAR";
            btnOk.onclick = () => ejecutarBorrar(id);
            document.getElementById('modal-confirm').style.display = 'flex';
        }

        async function ejecutarBorrar(id) {
            cerrarModal();
            try {
                const res = await fetch(`/api/ventas/eliminar/${id}`, { method: 'DELETE' });
                if(res.ok) cargarDatos();
                else mostrarAlerta("Error: Solo el administrador puede borrar ventas.", "error");
            } catch (e) { mostrarAlerta("Error de conexiÃ³n al servidor.", "error"); }
        }

        function pedirCierre() {
            document.getElementById('modal-titulo').innerText = "ğŸ”’ Cerrar Caja";
            document.getElementById('modal-texto').innerText = "Â¿Confirmar cierre de turno? El dinero volverÃ¡ a cero.";
            const btnOk = document.getElementById('btn-modal-ok');
            btnOk.style.background = "var(--success)";
            btnOk.style.color = "#000";
            btnOk.innerText = "CERRAR TURNO";
            btnOk.onclick = ejecutarCierre;
            document.getElementById('modal-confirm').style.display = 'flex';
        }

        async function ejecutarCierre() {
            cerrarModal();
            try {
                const res = await fetch('/api/caja/cerrar', { method: 'POST' });
                const data = await res.json();
                if(data.success) {
                mostrarAlerta("âœ… CAJA CERRADA CORRECTAMENTE", "success");
                setTimeout(() => { window.location.href = '/reportes.html'; }, 1500); // Espera 1.5s antes de redirigir
                }
                else mostrarAlerta("Error al cerrar caja.", "error");
            } catch (e) { mostrarAlerta("Error de conexiÃ³n al servidor.", "error"); }
        }

        cargarDatos();
    </script>
</body>
</html>