<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cerrar Caja - La Esquina</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0c0c0c">
    <meta name="mobile-web-app-capable" content="yes">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="La Esquina">
    <link rel="apple-touch-icon" href="/logo.png">
    <link rel="icon" href="/logo.png" type="image/png">
    <style>
        /* =========================================
           ESTILOS GENERALES
           ========================================= */
        body { 
            background: #0c0c0c; 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
        }
        
        /* BARRA LATERAL */
        .sidebar { 
            width: 260px; 
            background-color: #111; 
            border-right: 1px solid #333; 
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            height: 100%; 
            top: 0; 
            left: 0; 
            z-index: 100;
        }
        .sidebar-header { padding: 25px; text-align: center; border-bottom: 1px solid #222; }
        .logo-img { width: 180px; }
        .menu { padding: 20px 0; flex-grow: 1; }
        .menu-link { 
            display: flex; align-items: center; gap: 15px; 
            padding: 15px 25px; 
            color: #aaa; text-decoration: none; 
            transition: 0.2s; border-left: 3px solid transparent; 
        }
        .menu-link:hover { background: #1a1a1a; color: white; }
        .menu-link.active { background: #1a1a1a; color: #f1c40f; border-left-color: #f1c40f; font-weight: bold; }
        .btn-logout { 
            width: 90%; margin: 0 auto 20px; padding: 12px; 
            background: #222; color: #e74c3c; border: 1px solid #333; 
            border-radius: 6px; cursor: pointer; font-weight: bold; display: block; 
        }

        /* CONTENIDO PRINCIPAL */
        .main-content { margin-left: 260px; padding: 40px; width: 100%; }
        .page-title { 
            font-size: 28px; font-weight: bold; margin-bottom: 30px; 
            display: flex; align-items: center; gap: 10px; color: #f1c40f; 
        }

        /* TARJETAS DE RESUMEN */
        .resumen-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card-resumen { 
            background: #181818; 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid #333; 
            text-align: center; 
            position: relative; 
        }
        .card-titulo { 
            font-size: 11px; color: #888; 
            text-transform: uppercase; letter-spacing: 1px; 
            margin-bottom: 10px; font-weight: bold; 
        }
        .card-valor { font-size: 28px; font-weight: bold; }
        
        .val-total { color: #f1c40f; }
        .val-efectivo { color: #2ecc71; }
        .val-digital { color: #9b59b6; }
        .val-gastos { color: #e74c3c; }

        /* TABLA */
        .tabla-container { 
            background: #181818; 
            border-radius: 12px; 
            border: 1px solid #333; 
            overflow: hidden; 
            margin-bottom: 30px; 
        }
        .tabla-header { 
            background: #222; padding: 15px 25px; font-weight: bold; 
            display: flex; justify-content: space-between; 
            border-bottom: 1px solid #333; color: #f1c40f; 
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { 
            padding: 15px 25px; text-align: left; 
            border-bottom: 1px solid #222; font-size: 14px; 
        }
        th { color: #888; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        
        /* Etiquetas */
        .tag-pago { font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .tag-efectivo { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .tag-yape { background: rgba(155, 89, 182, 0.2); color: #9b59b6; }
        .tag-tarjeta { background: rgba(52, 152, 219, 0.2); color: #3498db; }

        /* Botones */
        .btn-cerrar-caja { 
            background: #c0392b; color: white; border: none; 
            padding: 15px 30px; font-size: 16px; font-weight: bold; 
            border-radius: 8px; cursor: pointer; float: right; transition: 0.2s; 
        }
        .btn-cerrar-caja:hover { 
            background: #e74c3c; transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4); 
        }

        .btn-borrar {
            background: #c0392b; color: white; border: none;
            padding: 6px 10px; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: 0.2s;
        }
        .btn-borrar:hover { background: #e74c3c; }

        /* MODAL OSCURO */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.85); 
            z-index: 1000; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px); 
        }
        .modal-box { 
            background: #1e1e1e; padding: 0; border-radius: 12px; 
            width: 90%; max-width: 400px; text-align: center; 
            border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.7); 
            overflow: hidden; 
        }
        .modal-title { 
            font-size: 18px; color: white; padding: 20px; 
            border-bottom: 1px solid #333; font-weight: bold; background: #222; 
        }
        .modal-body { padding: 25px; color: #ddd; font-size: 16px; }
        .modal-btns { 
            display: flex; gap: 15px; padding: 20px; 
            background: #222; border-top: 1px solid #333; 
        }
        .btn-modal { 
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; font-size: 14px; text-transform: uppercase; 
        }
        .btn-cancel { background: #444; color: white; }
        .btn-confirm { background: #c0392b; color: white; } /* Rojo para confirmar borrado */
        .btn-green { background: #27ae60; color: white; } /* Verde para confirmar cierre */

        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header"><img src="/logo.png" class="logo-img"></div>
        <div class="menu">
            <a href="/dashboard.html" class="menu-link"><span class="menu-icon">üé±</span> Control de Mesas</a>
            <a href="/inventario.html" class="menu-link"><span class="menu-icon">üì¶</span> Inventario</a>
            <a href="/reportes.html" class="menu-link"><span class="menu-icon">üìÖ</span> Historial</a>
            <a href="#" class="menu-link active"><span class="menu-icon">üîí</span> Cerrar Caja</a>
        </div>
        <button onclick="location.href='/logout'" class="btn-logout">üö™ SALIR</button>
    </nav>

    <main class="main-content">
        <div class="page-title">üîí Cierre de Turno</div>

        <div class="resumen-grid">
            <div class="card-resumen">
                <div class="card-titulo">üí∞ Ventas Totales</div>
                <div class="card-valor val-total" id="lbl-total-ventas">S/ 0.00</div>
            </div>
            <div class="card-resumen">
                <div class="card-titulo">üì± Yape / Tarjeta</div>
                <div class="card-valor val-digital" id="lbl-digital">S/ 0.00</div>
            </div>
            <div class="card-resumen">
                <div class="card-titulo">üìâ Gastos (Salidas)</div>
                <div class="card-valor val-gastos" id="lbl-gastos">S/ 0.00</div>
            </div>
            <div class="card-resumen" style="border-color: #2ecc71; background: #1a251a;">
                <div class="card-titulo">üíµ DINERO REAL EN CAJ√ìN</div>
                <div class="card-valor val-efectivo" id="lbl-en-cajon">S/ 0.00</div>
            </div>
        </div>

        <div class="tabla-container">
            <div class="tabla-header">üìú Detalle de Movimientos</div>
            <table id="tabla-ventas">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Concepto</th>
                        <th>M√©todo</th>
                        <th style="text-align: right;">Monto</th>
                        <th style="text-align: center; width: 60px;">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tbody-ventas">
                    <tr><td colspan="5" style="text-align:center; color:#555;">Cargando...</td></tr>
                </tbody>
            </table>
        </div>

        <button class="btn-cerrar-caja" onclick="pedirCierre()">CONFIRMAR Y CERRAR CAJA</button>
    </main>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-titulo">‚ö†Ô∏è Confirmaci√≥n</div>
            <div class="modal-body" id="modal-texto">¬øEst√°s seguro?</div>
            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-modal btn-confirm" id="btn-modal-ok">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <script>
        let accionPendiente = null; // Para guardar qu√© funci√≥n ejecutar al confirmar

        async function cargarDatos() {
            try {
                const res = await fetch('/api/caja/actual');
                const data = await res.json();

                // Llenar Tarjetas
                document.getElementById('lbl-total-ventas').innerText = 'S/ ' + data.total_ventas.toFixed(2);
                document.getElementById('lbl-gastos').innerText = 'S/ ' + data.total_gastos.toFixed(2);
                
                const totalDigital = data.desglose.digital + (data.desglose.tarjeta || 0); // Sumamos Yape + Tarjeta
                document.getElementById('lbl-digital').innerText = 'S/ ' + totalDigital.toFixed(2);
                document.getElementById('lbl-en-cajon').innerText = 'S/ ' + data.dinero_en_cajon.toFixed(2);

                // Llenar Tabla
                const tbody = document.getElementById('tbody-ventas');
                tbody.innerHTML = '';

                if (data.lista && data.lista.length > 0) {
                    data.lista.forEach(venta => {
                        let concepto = venta.tipo_mesa === 'BILLAR' ? 'üé± Billar' : 'üõí Consumo';
                        let metodo = venta.metodo_pago || 'EFECTIVO';
                        
                        let tagClass = 'tag-efectivo';
                        if(metodo === 'YAPE' || metodo === 'PLIN') tagClass = 'tag-yape';
                        if(metodo === 'TARJETA') tagClass = 'tag-tarjeta';

                        tbody.innerHTML += `
                            <tr>
                                <td style="color:#aaa;">${venta.hora}</td>
                                <td>${concepto} <span style="color:#555; font-size:11px;">#${venta.id}</span></td>
                                <td><span class="tag-pago ${tagClass}">${metodo}</span></td>
                                <td style="text-align: right; color:#eee; font-weight:bold;">S/ ${parseFloat(venta.total_final).toFixed(2)}</td>
                                <td style="text-align: center;">
                                    <button class="btn-borrar" onclick="pedirBorrar(${venta.id})" title="Eliminar Venta">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:#555;">No hay ventas registradas.</td></tr>';
                }

            } catch (e) { console.error(e); }
        }

        // --- SISTEMA DE MODALES ---

        function cerrarModal() {
            document.getElementById('modal-confirm').style.display = 'none';
        }

        // 1. L√≥gica para BORRAR VENTA
        function pedirBorrar(id) {
            document.getElementById('modal-titulo').innerText = "üóëÔ∏è Eliminar Venta";
            document.getElementById('modal-texto').innerText = "¬øEst√°s seguro de eliminar este cobro del reporte? Esto afectar√° el total en caja.";
            
            // Configurar bot√≥n rojo
            const btnOk = document.getElementById('btn-modal-ok');
            btnOk.className = "btn-modal btn-confirm"; 
            btnOk.innerText = "ELIMINAR";
            
            // Asignar funci√≥n
            btnOk.onclick = () => ejecutarBorrar(id);
            
            document.getElementById('modal-confirm').style.display = 'flex';
        }

        async function ejecutarBorrar(id) {
            cerrarModal();
            try {
                const res = await fetch(`/api/ventas/eliminar/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    cargarDatos(); // Recargamos para ver cambios
                } else {
                    alert("Error: Solo el administrador puede borrar ventas.");
                }
            } catch (e) { alert("Error de conexi√≥n"); }
        }

        // 2. L√≥gica para CERRAR CAJA
        function pedirCierre() {
            document.getElementById('modal-titulo').innerText = "üîí Cerrar Caja";
            document.getElementById('modal-texto').innerText = "¬øConfirmar cierre de turno? El dinero volver√° a cero.";
            
            // Configurar bot√≥n verde
            const btnOk = document.getElementById('btn-modal-ok');
            btnOk.className = "btn-modal btn-green"; 
            btnOk.innerText = "CERRAR TURNO";
            
            // Asignar funci√≥n
            btnOk.onclick = ejecutarCierre;
            
            document.getElementById('modal-confirm').style.display = 'flex';
        }

        async function ejecutarCierre() {
            cerrarModal();
            try {
                const res = await fetch('/api/caja/cerrar', { method: 'POST' });
                const data = await res.json();
                if(data.success) {
                    alert("‚úÖ CAJA CERRADA CORRECTAMENTE");
                    window.location.href = '/reportes.html';
                }
            } catch (e) { alert("Error de conexi√≥n"); }
        }

        // Cargar al inicio
        cargarDatos();
    </script>
</body>
</html>